version: "3.4"

services:
  emqtt-master:
    image: aksakalli/rpi-emq
    networks:
      Traefik_appnet:
      emq_net:
        aliases:
          - master.mq.tt
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 1s
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.backend=emqtt-master"
        - "traefik.port=18083"
        - "traefik.docker.network=Traefik_appnet"
        - "traefik.frontend.rule=Host:emq.iot.utn"
    environment:
      - "EMQ_NAME=emq"
      - "EMQ_NODE__COOKIE=ef16498f66804df1cc6172f6996d5493"
      - "EMQ_WAIT_TIME=600"

    volumes:
      - emq_cluster_master:/opt/emqttd
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true
      - type: bind
        source: /etc/timezone
        target: /etc/TZ
        read_only: true

    ports:
      - "1883:1883"   # - 1883 port for MQTT
      - "8883:8883"   # - 8883 port for MQTT(SSL)
      - "8083:8083"   # - 8083 for WebSocket/HTTP
      - "8084:8084"   # - 8084 for WSS/HTTPS
#    healthcheck:
#      test: nc -vz 127.0.0.1 8083 || exit 1
#      interval: 60s
#      timeout: 3s
#      retries: 10



  emqtt-worker:
    image: aksakalli/rpi-emq
    environment:
      - "EMQ_JOIN_CLUSTER=emq@emq-cluster_emqtt-master"
      - "EMQ_NODE__COOKIE=ef16498f66804df1cc6172f6996d5493"
      - "EMQ_WAIT_TIME=600"
    depends_on:
     - emqtt-master
    networks:
      emq_net:
    volumes:
      - type: volume
        source: emq_worker #{{.Task.Name}}
        target: /opt/emqttd    ### JPM
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true
      - type: bind
        source: /etc/timezone
        target: /etc/TZ
        read_only: true
    deploy:
      replicas: 2
      placement:
        constraints:
          - node.role == worker
      restart_policy:
        condition: on-failure
#    healthcheck:
#      test: nc -vz 127.0.0.1 8083 || exit 1
#      interval: 60s
#      timeout: 3s
#      retries: 10

networks:
  emq_net:
  Traefik_appnet:
    external: true

volumes:
  emq_worker:
  emq_cluster_master:
    driver: local
    driver_opts:
      type: cifs
#      bind-propagation: shared
      o: username=iot,password=frsniot,file_mode=0777,dir_mode=0777
      device: "//172.20.1.16/iot/emq_cluster/master"
